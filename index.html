<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Elite Athlete Training System ‚Äî Complete</title>
<style>
  /* ===== Base / Theme ===== */
  :root{
    --bg:#0a0a0a;--panel:#121212;--panel2:#1a1a1a;--muted:#777;--fg:#fff;
    --mint:#00ff88;--cyan:#00ccff;--warn:#ff6b35;--danger:#ff4444;--ok:#36d399;
    --line:#2a2a2a;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;background:var(--bg);color:var(--fg);line-height:1.55;padding:18px}
  .container{max-width:1600px;margin:0 auto}
  h1{font-size:40px;text-align:center;margin-bottom:6px;background:linear-gradient(90deg,var(--warn),var(--mint),var(--cyan));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .subtitle{color:#9aa;margin:8px 0 20px;text-align:center}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .btn{background:#2b2b2b;border:1px solid var(--line);color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn:hover{border-color:#555}
  .btn.primary{background:linear-gradient(135deg,var(--mint),var(--cyan));color:#000;border:none}
  .chip{display:inline-block;background:#222;border:1px solid #333;border-radius:999px;padding:4px 10px;font-size:12px;color:#bdd}
  /* Calendar */
  .cal-header{display:flex;justify-content:space-between;align-items:center;background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:14px 16px;margin:10px 0 14px;gap:10px;flex-wrap:wrap}
  .cal-title{font-weight:800;color:var(--mint);font-size:22px}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal-h{padding:8px;text-align:center;color:#9aa;font-weight:800}
  .day{background:var(--panel2);border:1px solid var(--line);border-radius:10px;min-height:110px;padding:8px;cursor:pointer;position:relative}
  .day:hover{border-color:#555;transform:translateY(-1px)}
  .day.other{opacity:.35}
  .day.today{border-color:var(--mint);box-shadow:0 0 18px rgba(0,255,136,.25)}
  .dnum{font-weight:900;margin-bottom:4px}
  .tags{font-size:10px;color:#aab}
  .badge{display:inline-block;font-size:10px;background:rgba(0,204,255,.12);border:1px solid var(--cyan);color:#9ef;border-radius:6px;padding:2px 6px;margin:1px}
  .cnsDot{position:absolute;right:7px;top:7px;width:14px;height:14px;border-radius:50%;border:2px solid #000}
  .cnsLow{background:var(--mint)}.cnsMod{background:#ffaa00}.cnsHigh{background:#ff4444}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:30;overflow:auto;padding:18px;display:flex}
  .card{margin:auto;max-width:1400px;width:100%;background:var(--panel);border:2px solid var(--mint);border-radius:12px;padding:18px}
  .mhead{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
  .mtitle{font-size:22px;color:var(--mint);font-weight:900}
  .x{background:var(--danger);border:none;color:#fff;border-radius:8px;padding:10px 14px;font-weight:800;cursor:pointer}
  .panel{background:var(--panel2);border:1px solid var(--line);border-radius:10px;padding:14px;margin:8px 0}
  .grid{display:grid;gap:10px}
  .g-2{grid-template-columns:repeat(2,1fr)}
  .g-3{grid-template-columns:repeat(3,1fr)}
  .g-4{grid-template-columns:repeat(4,1fr)}
  .lab{font-size:13px;color:#aab;margin:2px 0 6px}
  input,select,textarea{width:100%;padding:11px;border-radius:8px;border:1px solid #333;background:#0d0d0d;color:#fff}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#0f0f0f;border:1px solid #333;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer}
  .pill.on{border-color:var(--mint);box-shadow:inset 0 0 0 2px rgba(0,255,136,.2)}
  .kpi{display:flex;flex-direction:column;background:#0d0d0d;border-left:4px solid var(--cyan);border-radius:8px;padding:12px}
  .kval{font-size:26px;font-weight:900;color:var(--mint)}
  .kcap{font-size:11px;color:#9aa}
  .tip{font-size:12px;color:#9ad;background:rgba(0,204,255,.12);border:1px solid var(--cyan);border-radius:8px;padding:8px}
  .warn{background:rgba(255,68,68,.15);border:1px solid var(--danger);border-radius:8px;padding:10px}
  .ok{background:rgba(0,255,136,.15);border:1px solid var(--mint);border-radius:8px;padding:10px}
  .hidden{display:none}
  @media (max-width:900px){.g-4{grid-template-columns:repeat(2,1fr)}.g-3{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:640px){.g-2,.g-3,.g-4{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="container">
    <h1>üèÜ ELITE ATHLETE TRAINING SYSTEM</h1>
    <div class="subtitle">Full periodization ‚Ä¢ Load management ‚Ä¢ injury risk control ‚Ä¢ works offline (LocalStorage)</div>

    <div class="cal-header">
      <div class="row">
        <button class="btn" id="prevBtn">‚Äπ Prev</button>
        <button class="btn" id="todayBtn">Today</button>
        <button class="btn" id="nextBtn">Next ‚Ä∫</button>
      </div>
      <div class="cal-title" id="monthTitle"></div>
      <div class="row">
        <button class="btn" id="weeklyBtn">üìä Weekly Analysis</button>
        <button class="btn" id="profileBtn">üë§ Profile</button>
      </div>
    </div>

    <div class="cal-grid" id="grid"></div>
    <div id="modal" class="hidden"></div>
  </div>

<script>
/* ===================== STATE ===================== */
let currentDate=new Date();
const keyDay='eliteTrainingData_v2';
const keyTSS='eliteTSS28_v2';
const keyProfile='eliteProfile_v1';
let db=JSON.parse(localStorage.getItem(keyDay)||'{}');
let TSS=JSON.parse(localStorage.getItem(keyTSS)||'[]');
let profile=JSON.parse(localStorage.getItem(keyProfile)||'{}');

function save(){localStorage.setItem(keyDay,JSON.stringify(db));localStorage.setItem(keyTSS,JSON.stringify(TSS));localStorage.setItem(keyProfile,JSON.stringify(profile))}
function fmt(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${dd}`}

/* ===================== CALENDAR ===================== */
const grid=document.getElementById('grid'), title=document.getElementById('monthTitle');
function renderCal(){
  grid.innerHTML='';
  const y=currentDate.getFullYear(), m=currentDate.getMonth();
  title.textContent=new Date(y,m).toLocaleString('en-US',{month:'long',year:'numeric'});
  ['SUN','MON','TUE','WED','THU','FRI','SAT'].forEach(d=>{const h=document.createElement('div');h.className='cal-h';h.textContent=d;grid.appendChild(h)});
  const first=new Date(y,m,1).getDay(), days=new Date(y,m+1,0).getDate(), prevDays=new Date(y,m,0).getDate();
  const todayStr=fmt(new Date());
  for(let i=first-1;i>=0;i--){makeCell(new Date(y,m-1,prevDays-i),true,todayStr)}
  for(let d=1;d<=days;d++){makeCell(new Date(y,m,d),false,todayStr)}
  const filled=first+days, remain=(filled<=35?35:42)-filled;
  for(let d=1;d<=remain;d++){makeCell(new Date(y,m+1,d),true,todayStr)}
}
function makeCell(date,other,todayStr){
  const c=document.createElement('div');c.className='day'+(other?' other':''); if(fmt(date)===todayStr) c.classList.add('today');
  const ds=fmt(date), data=db[ds];
  c.innerHTML=`<div class="dnum">${date.getDate()}</div><div class="tags" id="t-${ds}"></div>`;
  if(data && data.modalities){const t=document.getElementById(`t-${ds}`)||c.querySelector('.tags');Object.keys(data.modalities).forEach(k=>data.modalities[k].completed&&t.insertAdjacentHTML('beforeend',`<span class="badge">${k.toUpperCase()}</span>`));const dot=document.createElement('div');dot.className='cnsDot '+(data.totalCNS<60?'cnsLow':data.totalCNS<75?'cnsMod':'cnsHigh');c.appendChild(dot)}
  c.onclick=()=>openDay(ds,date);
  grid.appendChild(c);
}
document.getElementById('prevBtn').onclick=()=>{currentDate.setMonth(currentDate.getMonth()-1);renderCal()}
document.getElementById('nextBtn').onclick=()=>{currentDate.setMonth(currentDate.getMonth()+1);renderCal()}
document.getElementById('todayBtn').onclick=()=>{currentDate=new Date();renderCal()}

/* ===================== MODALS ===================== */
function closeModal(){document.getElementById('modal').classList.add('hidden')}
function show(html){const m=document.getElementById('modal');m.innerHTML=html;m.classList.remove('hidden')}

/* ===================== PROFILE ===================== */
document.getElementById('profileBtn').onclick=()=>{
  show(`
  <div class="modal"><div class="card">
    <div class="mhead"><div class="mtitle">Athlete Profile</div><button class="x" onclick="closeModal()">‚úï Close</button></div>
    <div class="grid g-3">
      ${field('Age','p_age',profile.age||'number')}
      ${select('Sex','p_sex','', ['Male','Female','Other'],profile.sex||'')}
      ${field('Training age (yrs)','p_train',profile.train||'number')}
      ${field('Body mass (lb)','p_mass',profile.mass||'number')}
      ${field('Resting HR (bpm)','p_rhr',profile.rhr||'number')}
      ${field('HRmax (bpm)','p_hrmax',profile.hrmax||'number')}
    </div>
    <div class="tip" style="margin-top:8px">HR-based metrics (TRIMP) use HRmax. If unknown, set via an actual max or 208 ‚àí 0.7√óage.</div>
    <div class="row" style="margin-top:12px"><button class="btn primary" onclick="saveProfile()">Save Profile</button></div>
  </div></div>`)}
function field(lbl,id,valType){const v=(typeof valType==='string'&&valType!=='number')?valType:'';const t=(valType==='number'?'number':'text');return `<div class="panel"><div class="lab">${lbl}</div><input type="${t}" id="${id}" value="${v}"/></div>`}
function select(lbl,id,placeholder,opts,val){return `<div class="panel"><div class="lab">${lbl}</div><select id="${id}"><option value="">Choose...</option>${opts.map(o=>`<option ${val===o?'selected':''}>${o}</option>`).join('')}</select></div>`}
function saveProfile(){
  profile={age:+get('p_age'),sex:get('p_sex'),train:+get('p_train'),mass:+get('p_mass'),rhr:+get('p_rhr'),hrmax:+get('p_hrmax')};
  if(!profile.hrmax && profile.age) profile.hrmax=Math.round(208-0.7*profile.age);
  save();closeModal();
}
function get(id){const el=document.getElementById(id);return el?el.value:''}

/* ===================== DAY VIEW ===================== */
function pill(id,label,on){return `<span class="pill ${on?'on':''}" onclick="togglePill('${id}')"><input type="checkbox" id="${id}" ${on?'checked':''} style="display:none"/>${label}</span>`}
function togglePill(id){const c=document.getElementById(id);c.checked=!c.checked;c.parentElement.classList.toggle('on');const type=id.replace('chk-','');const section=document.getElementById(`sec-${type}`);if(c.checked){section.classList.remove('hidden')}else{section.classList.add('hidden')}}
function openDay(ds,date){
  const day=db[ds]||{modalities:{}};
  const on=(k)=>Boolean(day.modalities[k]);
  show(`
  <div class="modal"><div class="card">
    <div class="mhead"><div class="mtitle">${date.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}</div><button class="x" onclick="closeModal()">‚úï Close</button></div>

    <div class="panel">
      <div class="lab">Modalities (toggle)</div>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        ${pill('chk-chest','Chest',on('chest'))}
        ${pill('chk-back','Back',on('back'))}
        ${pill('chk-legs','Legs',on('legs'))}
        ${pill('chk-track','Track/Plyo',on('track'))}
        ${pill('chk-bike','Assault Bike',on('bike'))}
        ${pill('chk-bjj','BJJ',on('bjj'))}
        ${pill('chk-walk','Walking/Recovery',on('walk'))}
      </div>
    </div>

    <div class="grid g-3">
      <div class="kpi"><div class="kval" id="k-cns">0</div><div class="kcap">Estimated CNS Load</div></div>
      <div class="kpi"><div class="kval" id="k-tss">0</div><div class="kcap">Total TSS (TRIMP/sRPE)</div></div>
      <div class="kpi"><div class="kval" id="k-vol">0</div><div class="kcap">Strength Volume (lb)</div></div>
    </div>

    <!-- Strength sections -->
    ${strengthSection('chest',day.modalities.chest)}
    ${strengthSection('back',day.modalities.back)}
    ${strengthSection('legs',day.modalities.legs)}

    <!-- Track / Plyo (contacts-accurate version you requested) -->
    <div id="sec-track" class="${on('track')?'':'hidden'}">
      <div class="panel">
        <div class="lab">üèÉ Track / Plyometrics (contacts-accurate)</div>
        <div class="tip" style="margin-bottom:8px">Contacts = reps √ó jumps/rep (ground). <b>Stadium stairs</b>: contacts = steps/column √ó columns √ó jumps/step.</div>
        <div class="grid g-4">
          ${select('Exercise','trk_ex','', ['Broad Jump','Tuck Jump','Depth Jump','Bounds','Hurdle Hops','Single-leg Hops','Stair Jumps'], (day.modalities.track||{}).ex||'')}
          ${select('Unit','trk_unit','', ['Yards','Meters','Stadium Stairs'], (day.modalities.track||{}).unit||'')}
          ${field('Distance per rep (yards/meters)','trk_dist',(day.modalities.track||{}).dist||'number')}
          ${field('Reps','trk_reps',(day.modalities.track||{}).reps||'number')}
          ${field('Jumps per rep (ground)','trk_jpr',(day.modalities.track||{}).jpr||'number')}
          ${field('Steps per column (stairs)','trk_steps',(day.modalities.track||{}).steps||'number')}
          ${field('Columns completed (stairs)','trk_cols',(day.modalities.track||{}).cols||'number')}
          ${field('Jumps per step (stairs)','trk_jps',(day.modalities.track||{}).jps||'number')}
          ${select('Achilles/Calf','trk_ach','', ['Fresh','Tight','Sore'],(day.modalities.track||{}).ach||'')}
        </div>
        ${hrBlock('trk',day.modalities.track)}
      </div>
    </div>

    <!-- Assault Bike: UFC presets + your three customs -->
    <div id="sec-bike" class="${on('bike')?'':'hidden'}">
      <div class="panel">
        <div class="lab">üö¥ Assault Bike</div>
        <div class="grid g-4">
          ${select('Protocol','ab_proto','',[
            'UFC ‚Äî Gas Tank Builder (75% HR for 3min / rest 2min √ó 6)',
            'UFC ‚Äî Max Aerobic Power 15s on / 45s off √ó 10',
            'UFC ‚Äî Threshold 4√ó4min @ 85‚Äì90% HR, 2min easy',
            'Custom #1 ‚Äî Max RPM per rep (enter rounds)',
            'Custom #2 ‚Äî All-out to max RPM ‚Üí downshift and reach ‚â•Zone 5 ASAP (stop) ‚Äî recover to Zone 2 or 3min',
            'Custom #3 ‚Äî Rep1 all-out max RPM ‚Üí Rep2 cruise @ ~70% max for 30s (repeat)'
          ], (day.modalities.bike||{}).proto||'')}
          ${field('Total time (min)','ab_time',(day.modalities.bike||{}).time||'number')}
          ${field('Rounds / reps','ab_rounds',(day.modalities.bike||{}).rounds||'number')}
          ${field('Peak RPM (best)','ab_peak',(day.modalities.bike||{}).peak||'number')}
          ${field('Avg RPM (session)','ab_avg',(day.modalities.bike||{}).avg||'number')}
          ${field('Time to Zone 5 (sec) [Custom #2]','ab_tz5',(day.modalities.bike||{}).tz5||'number')}
          ${field('Recovery to Zone 2 (sec) [Custom #2]','ab_rz2',(day.modalities.bike||{}).rz2||'number')}
          ${select('Breathing quality','ab_br','', ['Strong','Moderate','Labored'],(day.modalities.bike||{}).br||'')}
          ${select('Overall feeling','ab_feel','', ['Great','Good','Tired','Beat'],(day.modalities.bike||{}).feel||'')}
        </div>
        ${hrBlock('ab',day.modalities.bike)}
      </div>
    </div>

    <!-- BJJ -->
    <div id="sec-bjj" class="${on('bjj')?'':'hidden'}">
      <div class="panel">
        <div class="lab">ü•ã BJJ</div>
        <div class="grid g-4">
          ${field('Spar time (min)','bjj_time',(day.modalities.bjj||{}).time||'number')}
          ${select('Intensity','bjj_int','', ['High','Medium','Light'],(day.modalities.bjj||{}).int||'')}
          ${field('Weight before (lb)','bjj_wb',(day.modalities.bjj||{}).wb||'number')}
          ${field('Weight after (lb)','bjj_wa',(day.modalities.bjj||{}).wa||'number')}
          ${select('Overall feeling (post-session)','bjj_feel','', ['Great','Good','Tired','Beat'],(day.modalities.bjj||{}).feel||'')}
        </div>
        ${hrBlock('bjj',day.modalities.bjj)}
      </div>
    </div>

    <!-- Walking -->
    <div id="sec-walk" class="${on('walk')?'':'hidden'}">
      <div class="panel">
        <div class="lab">üö∂ Walking / Recovery</div>
        <div class="grid g-4">
          ${field('Duration (min)','w_dur',(day.modalities.walk||{}).dur||'number')}
          ${field('Distance (mi)','w_dist',(day.modalities.walk||{}).dist||'number')}
          ${select('Terrain','w_ter','', ['Flat','Hills','Steep'],(day.modalities.walk||{}).ter||'')}
          ${select('Purpose','w_purp','', ['Active Recovery','Zone 2','General'],(day.modalities.walk||{}).purp||'')}
        </div>
        ${hrBlock('w',day.modalities.walk)}
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn primary" onclick="saveDay('${ds}')">‚úì Save Day & Recompute</button>
    </div>

  </div></div>`);
}
function strengthSection(name,data){
  const title=name.toUpperCase();
  const secId=`sec-${name}`;
  return `
  <div id="${secId}" class="${data?'':'hidden'}">
    <div class="panel">
      <div class="lab">üí™ ${title} ‚Äî Strength Session</div>
      <div id="${name}-exwrap"></div>
      <div class="row" style="margin-top:6px"><button class="btn" onclick="addExercise('${name}')">+ Add Exercise</button>
      <span class="chip">Volume auto-computed (lb)</span></div>
      <div class="grid g-3" style="margin-top:10px">
        ${select('Overall Feeling','feel_'+name,'', ['Great','Good','Tired','Beat'], (data||{}).feel||'')}
        ${field('Sleep (h)','slp_'+name,(data||{}).slp||'number')}
      </div>
      ${hrBlock(name,(data||{}))}
    </div>
  </div>`;
}
function hrBlock(prefix,data){
  const d=data||{};
  return `
  <div class="grid g-4" style="margin-top:10px">
    <div><div class="lab">Attach Polar HR screenshot (optional)</div><input type="file" accept="image/*" id="${prefix}_img"></div>
    ${field('Avg HR (bpm)',''+prefix+'_av', d.hr?.avg||'number')}
    ${field('Peak HR (bpm)',''+prefix+'_pk', d.hr?.peak||'number')}
    ${field('Time in Z5 (min)',''+prefix+'_z5', d.hr?.z5||'number')}
    ${field('Time in Z4 (min)',''+prefix+'_z4', d.hr?.z4||'number')}
  </div>
  <div class="tip" style="margin-top:6px">
    Image upload is stored locally for your log. Manual fields ensure accuracy without external APIs. If you later wire a backend OCR, post the parsed JSON to this app and populate these fields.
  </div>`;
}
function addExercise(group){
  const wrap=document.getElementById(group+'-exwrap');
  const id='ex_'+group+'_'+Math.random().toString(36).slice(2);
  const block=document.createElement('div');
  block.className='panel';
  block.innerHTML=`
    <div class="grid g-4">
      ${field('Exercise name',id+'_name','')}
      ${select('Muscle',''+id+'_mus','', ['Primary','Auxiliary','Accessory'],'')}
      ${field('Set √ó Reps',''+id+'_sr','')} 
      ${field('Weight per set (lb, comma-sep)',''+id+'_w','')}
    </div>
    <div class="grid g-4" style="margin-top:6px">
      ${field('Avg RPE (6-10)',''+id+'_rpe','')}
      ${field('Working sets (#)',''+id+'_sets','')}
      <div></div><div></div>
    </div>
  `;
  wrap.appendChild(block);
}

/* ===================== SAVE / METRICS ===================== */
function valNum(id){const v=get(id);return v?+v:0}
function collectHR(prefix){
  const hr={avg:valNum(prefix+'_av'),peak:valNum(prefix+'_pk'),z5:valNum(prefix+'_z5'),z4:valNum(prefix+'_z4')};
  // store image name only (no remote upload)
  const f=document.getElementById(prefix+'_img'); if(f && f.files && f.files[0]) hr.img=f.files[0].name;
  return hr;
}
function parseStrength(group){
  if(!document.getElementById('sec-'+group) || document.getElementById('sec-'+group).classList.contains('hidden')) return null;
  const exwrap=document.getElementById(group+'-exwrap');
  const exBlocks=[...exwrap.querySelectorAll('.panel')];
  const exercises=[];
  let vol=0, rpeSum=0, rpeN=0;
  exBlocks.forEach(b=>{
    const sel=[...b.querySelectorAll('input,select')];
    const name=sel.find(x=>x.id.includes('_name'))?.value||'';
    if(!name.trim()) return;
    const sr=(sel.find(x=>x.id.includes('_sr'))?.value||'').trim();
    const setsN=+(sel.find(x=>x.id.includes('_sets'))?.value||'0');
    const weights=(sel.find(x=>x.id.includes('_w'))?.value||'').split(',').map(s=>+s.trim()).filter(Boolean);
    const rpe=+((sel.find(x=>x.id.includes('_rpe'))?.value)||0);
    let reps=0; // support formats like "5x3" or "3x5"
    const m=sr.match(/(\d+)\s*x\s*(\d+)/i); if(m){reps=+m[2]}
    const wt=(weights.length?weights.reduce((a,b)=>a+b,0)/weights.length:0);
    const sets=(setsN||(+m?.[1]||0));
    const v=wt*reps*sets;
    vol+=v; if(rpe){rpeSum+=rpe;rpeN++}
    exercises.push({name,sets,reps,wt,rpe});
  });
  const feel=get('feel_'+group), slp=valNum('slp_'+group), hr=collectHR(group);
  // simple CNS scoring
  let cns=40 + (feel==='Beat'?18:feel==='Tired'?10:feel==='Great'?-8:0) + (hr.avg>=160?8:hr.avg>=150?5:0) + (slp<6.5?12:slp>=8?-6:0);
  const avgRPE=rpeN? (rpeSum/rpeN):0;
  if(avgRPE>=9)cns+=12; else if(avgRPE<=7)cns-=6;
  const duration=60; // min placeholder
  const tss_sRPE = duration * Math.max(0,avgRPE) ; // Foster sRPE
  return {completed:true,exercises,volume:Math.round(vol),cnsScore:clamp(cns,0,100),tss:Math.round(tss_sRPE),feel,slp,hr};
}
function parseTrack(){
  if(document.getElementById('sec-track').classList.contains('hidden')) return null;
  const ex=get('trk_ex'), unit=get('trk_unit'), dist=valNum('trk_dist'), reps=valNum('trk_reps'), jpr=valNum('trk_jpr'),
        steps=valNum('trk_steps'), cols=valNum('trk_cols'), jps=valNum('trk_jps'), ach=get('trk_ach'), hr=collectHR('trk');
  // contacts
  let contacts=0;
  if(unit==='Stadium Stairs'){ contacts = steps*cols*Math.max(1,jps) }
  else { contacts = Math.max(0,reps)*Math.max(1,jpr) }
  // CNS scoring emphasizes tendon load
  let cns=35 + (contacts>350?15:0) + (ach==='Sore'?25:ach==='Tight'?12:0) + (hr.z5>10?10:0);
  const tss = Math.round(60 + contacts*0.12); // calibrated conservative
  return {completed:true,ex,unit,dist,reps,jpr,steps,cols,jps,ach,contacts,cnsScore:clamp(cns,0,100),tss,hr};
}
function parseBike(){
  if(document.getElementById('sec-bike').classList.contains('hidden')) return null;
  const proto=get('ab_proto'), time=valNum('ab_time'), rounds=valNum('ab_rounds'), peak=valNum('ab_peak'), avg=valNum('ab_avg'),
        tz5=valNum('ab_tz5'), rz2=valNum('ab_rz2'), br=get('ab_br'), feel=get('ab_feel'), hr=collectHR('ab');
  let cns=45 + (br==='Labored'?18:br==='Moderate'?8:0) + (feel==='Beat'?18:feel==='Tired'?10:0) + (hr.z5>15?12:0);
  const intensityGuess = (proto.includes('Threshold')?0.85: proto.includes('Max Aerobic')?0.9: proto.includes('Gas Tank')?0.75 : proto.includes('Custom #2')?0.95 : proto.includes('Custom #1')?0.9 : proto.includes('Custom #3')?0.85 : 0.8);
  const tss = Math.round((time||rounds*1.5)*intensityGuess*100*0.2 + (hr.avg?hr.avg/2:0)); // blended heuristic
  return {completed:true,proto,time,rounds,peak,avg,tz5,rz2,br,feel,cnsScore:clamp(cns,0,100),tss,hr};
}
function parseBJJ(){
  if(document.getElementById('sec-bjj').classList.contains('hidden')) return null;
  const time=valNum('bjj_time'), int=get('bjj_int'), wb=valNum('bjj_wb'), wa=valNum('bjj_wa'), feel=get('bjj_feel'), hr=collectHR('bjj');
  const loss = (wb && wa)? +(wb-wa).toFixed(1):0;
  let cns=40 + (loss>=3?10:0) + (int==='High'?15:0) + (feel==='Beat'?18:feel==='Tired'?10:0) + (hr.z5>20?12:0);
  const tss=Math.round(time*1.5 + (int==='High'?30:0));
  return {completed:true,time,int,loss,feel,cnsScore:clamp(cns,0,100),tss,hr};
}
function parseWalk(){
  if(document.getElementById('sec-walk').classList.contains('hidden')) return null;
  const dur=valNum('w_dur'), dist=valNum('w_dist'), ter=get('w_ter'), purp=get('w_purp'), hr=collectHR('w');
  let cns=10 + (ter==='Steep'?15:ter==='Hills'?8:0);
  if(purp==='Zone 2' && hr.z3>hr.z2) cns+=10;
  const tss=Math.round(dur*0.5);
  return {completed:true,dur,dist,ter,purp,cnsScore:clamp(cns,0,100),tss,hr};
}
function clamp(x,a,b){return Math.max(a,Math.min(b,x))}
function saveDay(ds){
  const chest=parseStrength('chest'), back=parseStrength('back'), legs=parseStrength('legs'),
        track=parseTrack(), bike=parseBike(), bjj=parseBJJ(), walk=parseWalk();
  const modalities={}; if(chest)modalities.chest=chest; if(back)modalities.back=back; if(legs)modalities.legs=legs;
  if(track)modalities.track=track; if(bike)modalities.bike=bike; if(bjj)modalities.bjj=bjj; if(walk)modalities.walk=walk;
  if(Object.keys(modalities).length===0){alert('Select at least one modality');return}
  let totalCNS=0,totalVol=0,totalTSS=0;
  Object.values(modalities).forEach(m=>{totalCNS+=m.cnsScore||0; totalVol+=(m.volume||0); totalTSS+=(m.tss||0)})
  const day={modalities,totalCNS, totalVolume:totalVol, tss:totalTSS};
  db[ds]=day; TSS.push({date:ds,tss:totalTSS}); if(TSS.length>28) TSS.shift();
  save();
  // KPIs flash
  document.getElementById('k-cns').textContent=totalCNS;
  document.getElementById('k-tss').textContent=totalTSS;
  document.getElementById('k-vol').textContent=totalVol.toLocaleString();
  renderCal();
}

/* ===================== WEEKLY ===================== */
document.getElementById('weeklyBtn').onclick=()=>{
  const end=new Date(), start=new Date(); start.setDate(end.getDate()-6);
  let totC=0, totV=0, totT=0, n=0, dC=[];
  for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
    const k=fmt(d), x=db[k]; if(!x) continue; n++; totC+=x.totalCNS||0; totV+=x.totalVolume||0; totT+=x.tss||0; dC.push(x.totalCNS||0);
  }
  const avgC=Math.round(n?totC/n:0), avgT=Math.round(n?totT/n:0);
  const mean=avgC, varc=dC.length? dC.reduce((s,v)=>s+(v-mean)**2,0)/dC.length : 0, sd=Math.sqrt(varc), mono=sd? (mean/sd):0;
  const strain=Math.round(totC*mono);
  let ac='‚Äî', warn=false;
  if(TSS.length>=14){const chronic=TSS.reduce((a,b)=>a+b.tss,0)/TSS.length; if(chronic>0){ac=((avgT*7)/chronic).toFixed(2); warn=(+ac>1.3)}}
  show(`
  <div class="modal"><div class="card">
    <div class="mhead"><div class="mtitle">üìä Weekly Analysis</div><button class="x" onclick="closeModal()">‚úï Close</button></div>
    <div class="grid g-3">
      <div class="kpi"><div class="kval">${totV.toLocaleString()}</div><div class="kcap">Total Volume (lb)</div></div>
      <div class="kpi"><div class="kval">${avgC}</div><div class="kcap">Avg Daily CNS</div></div>
      <div class="kpi"><div class="kval">${totT}</div><div class="kcap">Weekly TSS</div></div>
      <div class="kpi" style="border-left-color:${warn?'#ff4444':'#ff6b35'}"><div class="kval" style="color:${warn?'#ff4444':'#00ff88'}">${ac}</div><div class="kcap">Acute:Chronic Ratio</div></div>
      <div class="kpi"><div class="kval">${mono.toFixed(2)}</div><div class="kcap">Monotony</div></div>
      <div class="kpi"><div class="kval">${strain}</div><div class="kcap">Strain</div></div>
    </div>
    ${warn? `<div class="warn" style="margin-top:10px"><b>Injury Risk:</b> A:C ${ac} (target 0.8‚Äì1.3). Reduce next week‚Äôs volume 15‚Äì20%, add 1‚Äì2 rest days, keep sleep ‚â•8h.</div>` :
             `<div class="ok" style="margin-top:10px">Load looks appropriate. Keep progressing conservatively.</div>`}
  </div></div>`)}
/* ===================== INIT ===================== */
renderCal();

/* ===================== Helpers ===================== */
</script>
</body>
</html>
