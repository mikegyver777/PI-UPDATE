<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elite Athlete Training System ‚Äî Integrated (Assault Bike Pro Applied)</title>
<style>
  *{box-sizing:border-box} html{-webkit-text-size-adjust:100%}
  body{margin:0;padding:20px;background:#0a0a0a;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial}
  .container{max-width:1600px;margin:0 auto}
  h1{margin:0 0 8px;text-align:center;font-size:38px;background:linear-gradient(90deg,#ff6b35,#00ff88,#00ccff);
     -webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .subtitle{text-align:center;color:#8a8a8a;margin-bottom:16px}
  .calendar-header{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;background:#151515;border:1px solid #2b2b2b;border-radius:12px;padding:14px}
  .calendar-nav button,.analysis-btn,.profile-btn{background:#2b2b2b;border:1px solid #3a3a3a;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
  .analysis-btn{background:linear-gradient(135deg,#00ff88,#00ccff);color:#032;border:none}
  .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:12px}
  .calendar-day-header{padding:10px;text-align:center;color:#9a9a9a;font-weight:800}
  .calendar-day{min-height:130px;background:#121212;border:1px solid #2a2a2a;border-radius:10px;padding:10px;cursor:pointer;position:relative}
  .calendar-day.today{border-color:#00ff88;box-shadow:0 0 20px rgba(0,255,136,.25)}
  .calendar-day.other-month{opacity:.35}
  .day-number{font-weight:800;margin-bottom:6px}
  .day-workouts{font-size:11px;color:#aaa}
  .workout-badge{display:inline-block;padding:3px 8px;margin:2px;border-radius:999px;background:rgba(0,204,255,.12);border:1px solid #00ccff;font-size:10px;font-weight:700}
  .cns-indicator{position:absolute;top:8px;right:8px;width:14px;height:14px;border-radius:50%}
  .cns-low{background:#00ff88}.cns-moderate{background:#ffaa00}.cns-high{background:#ff4444}
  .hidden{display:none}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:1000;overflow:auto;padding:18px}
  .modal-content{max-width:1400px;margin:0 auto;background:#0a0a0a;border:2px solid #00ff88;border-radius:12px;padding:28px}
  .modal-header{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:16px}
  .modal-title{font-size:28px;color:#00ff88}
  .close-btn{background:#ff4444;border:none;color:#fff;padding:10px 16px;border-radius:8px;font-weight:800;cursor:pointer}
  /* Sections */
  .modality-checkboxes{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:18px;background:#151515;border:1px solid #2b2b2b;border-radius:12px;padding:14px}
  .modality-checkbox{display:flex;align-items:center;gap:10px;padding:12px;background:#0a0a0a;border:1px solid #333;border-radius:10px;cursor:pointer}
  .modality-checkbox.checked{border-color:#00ff88;background:rgba(0,255,136,.08)}
  .modality-section{background:#151515;border:1px solid #00ccff;border-radius:12px;padding:18px;margin-bottom:14px}
  .modality-section h2{color:#00ccff;margin:0 0 10px}
  .question{margin-bottom:12px}
  .question label{display:block;color:#9a9a9a;margin-bottom:6px;font-weight:700}
  input,select,textarea{width:100%;background:#141414;border:1px solid #333;color:#fff;border-radius:8px;padding:10px;font-size:14px}
  input:focus,select:focus,textarea:focus{outline:none;border-color:#00ff88;box-shadow:0 0 0 3px rgba(0,255,136,.1)}
  .upload-zone{border:1px dashed #444;border-radius:10px;padding:14px;text-align:center;cursor:pointer}
  .upload-zone.has-file{border-style:solid;border-color:#00ff88;background:rgba(0,255,136,.04)}
  .hr-preview{max-width:100%;max-height:260px;border-radius:10px;margin-top:8px}
  .metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
  .metric-card{background:#0f0f0f;border-left:4px solid #00ccff;border-radius:10px;padding:14px}
  .metric-value{font-size:26px;font-weight:900;color:#00ff88}
  .ok{background:rgba(0,255,136,.12);border:1px solid #00ff88;border-radius:10px;padding:10px}
  .warn{background:rgba(255,68,68,.12);border:1px solid #ff4444;border-radius:10px;padding:10px}
  .btn{background:#2b2b2b;border:1px solid #3a3a3a;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:800}
  .btn-primary{background:linear-gradient(135deg,#00ff88,#00ccff);border:none;color:#032}
  .table{width:100%;border-collapse:collapse;margin-top:8px}
  .table th,.table td{border:1px solid #2b2b2b;padding:8px;text-align:center}
  @media(max-width:760px){.modal-content{padding:18px} h1{font-size:28px} }
</style>
<!-- OCR for Polar screenshot parsing -->
<script src="https://unpkg.com/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>üèÜ ELITE ATHLETE TRAINING SYSTEM</h1>
    <p class="subtitle">Full Periodization ‚Ä¢ Load Management ‚Ä¢ Injury Prevention ‚Ä¢ Performance Optimization (Assault Bike upgraded + HR OCR)</p>

    <div class="calendar-header">
      <div class="calendar-nav">
        <button onclick="previousMonth()">‚Äπ Prev</button>
        <button onclick="goToToday()">Today</button>
        <button onclick="nextMonth()">Next ‚Ä∫</button>
      </div>
      <div class="month-title" id="month-title">‚Äî</div>
      <div style="display:flex; gap:8px">
        <button class="profile-btn" onclick="openProfile()">üë§ Profile</button>
        <button class="analysis-btn" onclick="showWeeklyAnalysis()">üìä WEEKLY ANALYSIS</button>
      </div>
    </div>

    <div class="calendar-grid" id="calendar-grid"></div>

    <!-- Modals -->
    <div id="day-modal" class="hidden"></div>
    <div id="weekly-modal" class="hidden"></div>
    <div id="rpe-modal" class="hidden"></div>
    <div id="profile-modal" class="hidden"></div>
  </div>

<script>
/* =================== CORE STATE (unchanged layout) =================== */
let currentDate = new Date();
let trainingData = {}; // { 'YYYY-MM-DD': { modalities: {...}, totalCNS, totalVolume, tss, hrData } }
let historicalTSS = []; // for A:C
let exerciseCounters = {};
let setCounters = {};

/* ------- Persistence ------- */
function loadData(){
  trainingData = JSON.parse(localStorage.getItem('eliteTrainingData')||'{}');
  historicalTSS = JSON.parse(localStorage.getItem('historicalTSS')||'[]');
}
function saveData(){
  localStorage.setItem('eliteTrainingData', JSON.stringify(trainingData));
  localStorage.setItem('historicalTSS', JSON.stringify(historicalTSS));
}

/* =================== CALENDAR (unchanged) =================== */
function renderCalendar(){
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const monthNames = ['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];
  document.getElementById('month-title').textContent = `${monthNames[month]} ${year}`;

  const grid = document.getElementById('calendar-grid'); grid.innerHTML='';
  ['SUN','MON','TUE','WED','THU','FRI','SAT'].forEach(d=>{
    const header=document.createElement('div'); header.className='calendar-day-header'; header.textContent=d; grid.appendChild(header);
  });
  const firstDay = new Date(year,month,1).getDay();
  const daysInMonth = new Date(year,month+1,0).getDate();
  const daysInPrevMonth = new Date(year,month,0).getDate();
  const today = formatDate(new Date());

  for(let i=firstDay-1;i>=0;i--){ const date=new Date(year,month-1,daysInPrevMonth-i); createDayCell(grid,date,true,today); }
  for(let day=1;day<=daysInMonth;day++){ const date=new Date(year,month,day); createDayCell(grid,date,false,today); }
  const totalCells = firstDay + daysInMonth;
  const remaining = totalCells<=35?35-totalCells:42-totalCells;
  for(let d=1; d<=remaining; d++){ const date=new Date(year,month+1,d); createDayCell(grid,date,true,today); }
}
function createDayCell(grid,date,other,today){
  const cell=document.createElement('div'); cell.className='calendar-day'; if(other) cell.classList.add('other-month');
  const dateStr=formatDate(date); if(dateStr===today) cell.classList.add('today');
  const dayData=trainingData[dateStr];
  const dayNum=document.createElement('div'); dayNum.className='day-number'; dayNum.textContent=date.getDate(); cell.appendChild(dayNum);
  if(dayData && dayData.modalities){
    cell.classList.add('has-workouts');
    const workouts=document.createElement('div'); workouts.className='day-workouts';
    Object.keys(dayData.modalities).forEach(type=>{
      if(dayData.modalities[type].completed){
        const b=document.createElement('span'); b.className='workout-badge'; b.textContent=type.toUpperCase(); workouts.appendChild(b);
      }
    }); cell.appendChild(workouts);
    const c=document.createElement('div'); c.className='cns-indicator';
    const totalCNS=dayData.totalCNS||0; if(totalCNS<60) c.classList.add('cns-low'); else if(totalCNS<75) c.classList.add('cns-moderate'); else c.classList.add('cns-high');
    cell.appendChild(c);
  }
  cell.onclick=()=>openDay(dateStr,date);
  grid.appendChild(cell);
}
function formatDate(date){ const y=date.getFullYear(), m=String(date.getMonth()+1).padStart(2,'0'), d=String(date.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
function previousMonth(){ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); }
function nextMonth(){ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); }
function goToToday(){ currentDate = new Date(); renderCalendar(); }

/* =================== PROFILE (added) =================== */
let profile = JSON.parse(localStorage.getItem('ets_profile')||'{}');
function ensureProfile(){ if(!profile.sex) profile.sex='male'; if(!profile.age) profile.age=30; if(!profile.rhr) profile.rhr=60; if(!profile.hrmax) profile.hrmax=Math.round(208-0.7*profile.age); }
function hrZones(){ ensureProfile(); const hm=profile.hrmax; return { z2:[Math.round(hm*0.60),Math.round(hm*0.70)], z3:[Math.round(hm*0.70),Math.round(hm*0.80)], z4:[Math.round(hm*0.80),Math.round(hm*0.90)], z5:[Math.round(hm*0.90),hm] }; }
function openProfile(){
  ensureProfile();
  const html=`
    <div class="modal"><div class="modal-content">
      <div class="modal-header"><div class="modal-title">üë§ Athlete Profile</div><button class="close-btn" onclick="document.getElementById('profile-modal').classList.add('hidden')">Close</button></div>
      <div class="modality-section">
        <div class="question"><label>Sex</label><select id="pf_sex"><option value="male"${profile.sex==='male'?' selected':''}>Male</option><option value="female"${profile.sex==='female'?' selected':''}>Female</option></select></div>
        <div class="question"><label>Age (yrs)</label><input id="pf_age" type="number" value="${profile.age}"></div>
        <div class="question"><label>Resting HR (bpm)</label><input id="pf_rhr" type="number" value="${profile.rhr}"></div>
        <div class="question"><label>HRmax (auto if blank)</label><input id="pf_hrmax" type="number" placeholder="${Math.round(208-0.7*profile.age)}"></div>
        <div class="ok">Zones (auto): Z2 ${hrZones().z2.join('-')} ‚Ä¢ Z3 ${hrZones().z3.join('-')} ‚Ä¢ Z4 ${hrZones().z4.join('-')} ‚Ä¢ Z5 ${hrZones().z5.join('-')} bpm</div>
        <div style="margin-top:10px"><button class="btn btn-primary" onclick="saveProfile()">Save Profile</button></div>
      </div>
    </div></div>`;
  const node=document.getElementById('profile-modal'); node.innerHTML=html; node.classList.remove('hidden');
}
function saveProfile(){
  const sex=document.getElementById('pf_sex').value;
  const age=parseInt(document.getElementById('pf_age').value)||30;
  const rhr=parseInt(document.getElementById('pf_rhr').value)||60;
  const hm=parseInt(document.getElementById('pf_hrmax').value);
  profile={sex,age,rhr,hrmax:Number.isFinite(hm)?hm:Math.round(208-0.7*age)};
  localStorage.setItem('ets_profile',JSON.stringify(profile));
  document.getElementById('profile-modal').classList.add('hidden');
  alert('Profile saved.');
}

/* =================== DAY MODAL (keep layout; improve BIKE only) =================== */
let currentEditingDate=null;
function openDay(dateStr, date){
  currentEditingDate=dateStr;
  const dayData=trainingData[dateStr]||{modalities:{}};
  exerciseCounters={}; setCounters={};
  const html=`
    <div class="modal"><div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">${date.toLocaleDateString('en-US',{weekday:'long', year:'numeric', month:'long', day:'numeric'})}</div>
        <button class="close-btn" onclick="closeAnyModal()">‚úï Close</button>
      </div>
      <h3 style="color:#00ff88;margin-bottom:10px">Select today's modalities</h3>
      <div class="modality-checkboxes">
        ${['chest','back','legs','track','bike','bjj','walking'].map(t=>{
          const on=dayData.modalities[t]?' checked':'';
          return `<div class="modality-checkbox${on?' checked':''}" onclick="toggleModality('${t}')">
            <input type="checkbox" id="check-${t}"${on?' checked':''}>
            <label for="check-${t}">${iconFor(t)} ${t.toUpperCase()}</label>
          </div>`}).join('')}
      </div>
      <div id="form-chest" class="hidden modality-section"></div>
      <div id="form-back" class="hidden modality-section"></div>
      <div id="form-legs" class="hidden modality-section"></div>
      <div id="form-track" class="hidden modality-section"></div>
      <div id="form-bike" class="hidden modality-section"></div>
      <div id="form-bjj" class="hidden modality-section"></div>
      <div id="form-walking" class="hidden modality-section"></div>
      <button class="btn btn-primary" style="width:100%;margin-top:10px" onclick="saveDay('${dateStr}')">‚úì SAVE ALL TRAINING & ANALYZE</button>
    </div></div>`;
  document.getElementById('day-modal').innerHTML=html;
  document.getElementById('day-modal').classList.remove('hidden');
  Object.keys(dayData.modalities||{}).forEach(type=>{ if(dayData.modalities[type]) showModalityForm(type,dayData.modalities[type]); });
}
function iconFor(t){ return t==='chest'?'üí™':t==='back'?'üí™':t==='legs'?'ü¶µ':t==='track'?'üèÉ':t==='bike'?'üö¥':t==='bjj'?'ü•ã':'üö∂'; }
function toggleModality(type){
  const cb=document.getElementById('check-'+type); cb.checked=!cb.checked;
  const wrap=cb.parentElement; wrap.classList.toggle('checked');
  if(cb.checked) showModalityForm(type); else document.getElementById('form-'+type).classList.add('hidden');
}
function closeAnyModal(){ document.getElementById('day-modal').classList.add('hidden'); document.getElementById('weekly-modal').classList.add('hidden'); hrData={}; }

/* =================== FORMS =================== */
function showModalityForm(type,data=null){
  const form=document.getElementById('form-'+type); form.classList.remove('hidden');
  if(type==='chest'||type==='back'||type==='legs'){ form.innerHTML=generateWeightForm(type,data); addExercise(type); }
  else if(type==='track'){ form.innerHTML=generateTrackForm(data); }
  else if(type==='bike'){ form.innerHTML=generateBikeFormUpgraded(data); wireBikeProto(); }
  else if(type==='bjj'){ form.innerHTML=generateBJJForm(data); }
  else if(type==='walking'){ form.innerHTML=generateWalkingForm(data); }
}
/* --- weight form (unchanged minimal) --- */
function generateWeightForm(type,data){
  return `
    <h2>üí™ ${type.toUpperCase()} TRAINING</h2>
    <div class="question"><label>Exercise</label><input class="exercise-name" placeholder="e.g., Bench Press"></div>
    <div class="question"><label>Muscle group</label>
      <select class="muscle-select">
        <option value="">Select...</option><option value="chest">Chest</option><option value="back">Back</option>
        <option value="quads">Quads</option><option value="hamstrings">Hamstrings</option><option value="glutes">Glutes</option>
        <option value="shoulders">Shoulders</option><option value="biceps">Biceps</option><option value="triceps">Triceps</option><option value="core">Core</option>
      </select>
    </div>
    <div class="question"><label>Working sets (weight √ó reps √ó RPE)</label>
      <div class="table-wrap"><table class="table" id="${type}-tbl"><thead><tr><th>Set</th><th>Weight (lb)</th><th>Reps</th><th>RPE</th></tr></thead>
      <tbody>${[1,2,3].map(i=>`<tr><td>${i}</td><td><input class="w${i}"></td><td><input class="r${i}"></td><td><input class="p${i}"></td></tr>`).join('')}</tbody></table></div>
    </div>
    <div class="question"><label>Overall feeling</label>
      <select id="${type}-feeling"><option value="">Choose...</option><option value="great">Great</option><option value="good">Good</option><option value="tired">Tired</option><option value="beat">Beat Up</option></select>
    </div>
    <div class="question"><label>Sleep last night (h)</label><input type="number" id="${type}-sleep" step="0.5" placeholder="7.5"></div>
  `;
}
function addExercise(type){/* simple starter rows already present */}

/* --- track form (unchanged minimal) --- */
function generateTrackForm(data){
  return `
    <h2>üèÉ TRACK / PLYOMETRICS</h2>
    <div class="question"><label>Total contacts (all plyos)</label><input id="track-contacts" type="number" placeholder="300"></div>
    <div class="question"><label>Max effort jumps</label><input id="track-max-jumps" type="number" placeholder="10"></div>
    <div class="question"><label>Sprints (count)</label><input id="track-sprints" type="number" placeholder="5"></div>
    <div class="question"><label>Ground feel</label><select id="track-ground"><option value="">Choose...</option><option value="bouncy">Bouncy</option><option value="normal">Normal</option><option value="heavy">Heavy</option></select></div>
    <div class="question"><label>Energy level</label><select id="track-energy"><option value="">Choose...</option><option value="high">High</option><option value="moderate">Moderate</option><option value="low">Low</option></select></div>
    <div class="question"><label>Achilles/calf status</label><select id="track-achilles"><option value="">Choose...</option><option value="fresh">Fresh</option><option value="tight">Tight</option><option value="sore">Sore</option></select></div>
    <div class="question"><label>Sleep (h)</label><input id="track-sleep" type="number" step="0.5" placeholder="7.5"></div>
  `;
}

/* --- BJJ form (unchanged minimal) --- */
function generateBJJForm(data){
  return `
    <h2>ü•ã JIU JITSU</h2>
    <div class="question"><label>Spar time (min)</label><input id="bjj-time" type="number" placeholder="45"></div>
    <div class="question"><label>Intensity</label><select id="bjj-intensity"><option value="">Choose...</option><option value="high">High</option><option value="medium">Medium</option><option value="light">Light</option></select></div>
    <div class="question"><label>Weight before (lb)</label><input id="bjj-weight-before" type="number" step="0.1"></div>
    <div class="question"><label>Weight after (lb)</label><input id="bjj-weight-after" type="number" step="0.1"></div>
    <div class="question"><label>Overall feeling</label><select id="bjj-feeling"><option>great</option><option>good</option><option>tired</option><option>beat</option></select></div>
    <div class="question"><label>Sleep (h)</label><input id="bjj-sleep" type="number" step="0.5"></div>
  `;
}

/* --- walking form (unchanged minimal) --- */
function generateWalkingForm(data){
  return `
    <h2>üö∂ WALKING / RECOVERY</h2>
    <div class="question"><label>Duration (min)</label><input id="walking-duration" type="number" placeholder="30"></div>
    <div class="question"><label>Distance (miles)</label><input id="walking-distance" type="number" step="0.1"></div>
    <div class="question"><label>Avg pace (min/mile)</label><input id="walking-pace" type="number" step="0.1"></div>
    <div class="question"><label>Terrain</label><select id="walking-terrain"><option value="">Choose...</option><option value="flat">Flat</option><option value="hills">Hills</option><option value="steep">Steep</option></select></div>
    <div class="question"><label>Purpose</label><select id="walking-purpose"><option value="">Choose...</option><option value="recovery">Active Recovery</option><option value="zone2">Zone 2 Cardio</option><option value="general">General Activity</option></select></div>
  `;
}

/* =================== ASSAULT BIKE ‚Äî UPGRADED (applied) =================== */
const hrStore = {};
function generateBikeFormUpgraded(data){
  const z = hrZones();
  return `
    <h2>üö¥ ASSAULT BIKE ‚Äî Elite Protocols</h2>
    <div class="ok">Auto HR zones (profile): Z2 ${z.z2.join('-')} ‚Ä¢ Z3 ${z.z3.join('-')} ‚Ä¢ Z4 ${z.z4.join('-')} ‚Ä¢ Z5 ${z.z5.join('-')} bpm</div>
    <div class="question"><label>Protocol</label>
      <select id="bk_proto">
        <optgroup label="UFC PI ‚Äî Classic">
          <option value="pi_gasTank">Gas Tank Builder (Z2 steady 30‚Äì45m)</option>
          <option value="pi_vo2peaks">VO‚ÇÇ Peaks (30/30 √ó 10‚Äì15)</option>
          <option value="pi_thres_3min">Threshold 3-min (3√ó3' @ LT)</option>
          <option value="pi_mixed">Mixed MAP (40/20 √ó 12)</option>
        </optgroup>
        <optgroup label="Your Customs">
          <option value="c_max_rpm">Custom 1 ‚Äî Max RPM Repeats</option>
          <option value="c_peak_then_z5">Custom 2 ‚Äî Peak ‚Üí downshift to reach Zone 5 ASAP, then stop</option>
          <option value="c_peak_then_steady">Custom 3 ‚Äî Peak, then 70% of session max for 30s</option>
        </optgroup>
      </select>
    </div>
    <div class="question"><label>Planned rounds</label><input id="bk_rounds" type="number" value="6"></div>
    <div id="bk_dynamic"></div>
    <div class="question"><label>Session feel</label><select id="bk_feel"><option>great</option><option>good</option><option>tired</option><option>beat</option></select></div>
    <div class="question"><label>Sleep (h)</label><input id="bk_sleep" type="number" step="0.5"></div>
    <div class="question"><label>Polar HR screenshot</label>
      <div class="upload-zone" id="bk_upload">üìä Upload & OCR</div>
      <input type="file" id="bk_file" accept="image/*" class="hidden"/>
      <img id="bk_hrimg" class="hr-preview hidden">
      <div id="bk_hrtxt" style="color:#9a9a9a;font-size:12px;margin-top:6px"></div>
    </div>
    <div class="metrics-grid">
      <div class="metric-card"><div class="metric-value" id="bk_tss">0</div><div>TRIMP/sRPE TSS</div></div>
      <div class="metric-card"><div class="metric-value" id="bk_cns">0</div><div>Estimated CNS Load</div></div>
      <div class="metric-card"><div class="metric-value" id="bk_next">‚Äî</div><div>Next Session Suggestion</div></div>
    </div>
  `;
}
function wireBikeProto(){
  const el = document.getElementById('bk_proto');
  const roundsEl = document.getElementById('bk_rounds');
  const dyn = document.getElementById('bk_dynamic');
  function table(headers, rows=6){
    const th=headers.map(h=>`<th>${h}</th>`).join('');
    let body=''; for(let i=1;i<=rows;i++){ body+=`<tr>${headers.map((h,j)=> j===0?`<td>${i}</td>`:`<td><input class="r${i} c${j}"></td>`).join('')}</tr>`; }
    return `<table class="table" id="bk_tbl"><thead><tr>${th}</tr></thead><tbody>${body}</tbody></table>`;
  }
  function renderDynamic(){
    const v = el.value; const r = parseInt(roundsEl.value)||6;
    if(v==='pi_gasTank'){
      const z = hrZones();
      dyn.innerHTML = `
        <div class="ok">Ride ${Math.max(30, r*5)}‚Äì45 min in Z2 (${z.z2[0]}‚Äì${z.z2[1]} bpm). Enter average RPM if desired.</div>
        <div class="question"><label>Avg RPM</label><input id="gt_avg" type="number"></div>
      `;
    } else if(v==='pi_vo2peaks'){
      dyn.innerHTML = table(['Round','Work 30s RPM','Rest 30s RPM','Peak RPM','Notes'], r);
    } else if(v==='pi_thres_3min'){
      dyn.innerHTML = table(['Block','3-min Avg RPM','Target HR','Achieved HR','Notes'], Math.max(3, r));
    } else if(v==='pi_mixed'){
      dyn.innerHTML = table(['Rep','40s RPM','20s RPM','Peak RPM','Notes'], r);
    } else if(v==='c_max_rpm'){
      dyn.innerHTML = table(['Rep','Peak RPM','Time @ Peak (s)','Recovery to Z2 (s)','Notes'], r);
    } else if(v==='c_peak_then_z5'){
      dyn.innerHTML = table(['Rep','Peak RPM','Time to Zone 5 (s)','Recovery to Z2 or 180s (s)','Notes'], r);
    } else if(v==='c_peak_then_steady'){
      dyn.innerHTML = `<div class="warn">Odd reps: all-out peak. Even reps: hold ~70% of session max for 30s.</div>` + table(['Rep','Mode (peak/70%)','Peak/Avg RPM','Hold Time (s)','Recovery (s)','Notes'], r);
    }
    const tbl=document.getElementById('bk_tbl'); if(tbl){ tbl.addEventListener('input', computeBikeMetricsUpgraded); }
  }
  el.addEventListener('change', renderDynamic); roundsEl.addEventListener('input', renderDynamic);
  renderDynamic();
  // OCR wire
  document.getElementById('bk_upload').onclick=()=>document.getElementById('bk_file').click();
  document.getElementById('bk_file').onchange=e=>hrOCR_BIKE(e);
  // Compute when feel/sleep change
  document.getElementById('bk_feel').addEventListener('change', computeBikeMetricsUpgraded);
  document.getElementById('bk_sleep').addEventListener('input', computeBikeMetricsUpgraded);
  computeBikeMetricsUpgraded();
}
async function hrOCR_BIKE(evt){
  const f=evt.target.files[0]; if(!f) return;
  const img=document.getElementById('bk_hrimg'), out=document.getElementById('bk_hrtxt');
  img.src=URL.createObjectURL(f); img.classList.remove('hidden'); out.textContent="Analyzing HR screenshot‚Ä¶";
  try{
    const {data:{text}} = await Tesseract.recognize(img.src,'eng',{
      tessedit_char_whitelist:'0123456789:%-ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz '
    });
    const peak = readNum(/peak[^0-9]{0,6}([0-9]{2,3})/i, text) ?? readNum(/max[^0-9]{0,6}([0-9]{2,3})/i, text);
    const avg  = readNum(/avg[^0-9]{0,6}([0-9]{2,3})/i, text)  ?? readNum(/average[^0-9]{0,6}([0-9]{2,3})/i, text);
    const z5   = readNum(/zone\s*5[^0-9]{0,6}([0-9]{1,3})\s*m/i, text)||0;
    const z4   = readNum(/zone\s*4[^0-9]{0,6}([0-9]{1,3})\s*m/i, text)||0;
    const z3   = readNum(/zone\s*3[^0-9]{0,6}([0-9]{1,3})\s*m/i, text)||0;
    const z2   = readNum(/zone\s*2[^0-9]{0,6}([0-9]{1,3})\s*m/i, text)||0;
    const rec  = inferRecovery(avg, peak);
    hrStore['bike'] = {peakHR:peak||null, avgHR:avg||null, timeInZone5:z5, timeInZone4:z4, timeInZone3:z3, timeInZone2:z2, recovery:rec};
    out.innerHTML = `‚úì Parsed ‚Äî Peak <b>${peak||'?'}</b> ‚Ä¢ Avg <b>${avg||'?'}</b> ‚Ä¢ Z5:<b>${z5}m</b> Z4:<b>${z4}m</b> Z3:<b>${z3}m</b> Z2:<b>${z2}m</b> ‚Ä¢ Recovery <b>${rec}</b>`;
    computeBikeMetricsUpgraded();
  }catch(e){ console.error(e); out.textContent="‚ö†Ô∏è OCR failed; you can still enter values manually."; }
}
function readNum(rx,txt){ const m=rx.exec(txt); if(!m) return null; const n=parseInt(m[1],10); return isFinite(n)?n:null; }
function inferRecovery(avg,peak){ if(!avg||!peak) return "moderate"; const r=avg/peak; if(r>=0.88) return "poor"; if(r<=0.75) return "good"; return "moderate"; }

function computeBikeMetricsUpgraded(){
  ensureProfile();
  const proto=(document.getElementById('bk_proto')||{}).value||'pi_gasTank';
  const rounds=parseInt((document.getElementById('bk_rounds')||{}).value)||6;
  const feel=((document.getElementById('bk_feel')||{}).value||'good').toLowerCase();
  const sleep=parseFloat((document.getElementById('bk_sleep')||{}).value)||0;
  const hr=hrStore['bike']||null;

  // TRIMP / sRPE hybrid
  let tss;
  if(hr && hr.avgHR){
    const hrr=(hr.avgHR - profile.rhr)/(profile.hrmax - profile.rhr);
    const y = profile.sex==='female'?1.92:1.67;
    tss = Math.round( (rounds*60/2) * hrr * y / 60 ); // rough: assume ~30s work/round average across patterns
  }else{
    const feelRPE = (feel==="beat")?9.5:(feel==="tired")?8.5:(feel==="good")?7.5:7.0;
    tss = Math.round(feelRPE * Math.max(12,rounds*2.5)); // minutes heuristic
  }

  // CNS heuristic
  let cns=45;
  if(feel==="beat") cns+=18; else if(feel==="tired") cns+=10; else if(feel==="great") cns-=8;
  if(sleep && sleep<7) cns+=8; else if(sleep>=8) cns-=4;
  if(hr){ if(hr.avgHR>=170) cns+=10; if(hr.recovery==="poor") cns+=8; }

  // Table-driven refinements
  const tbl=document.getElementById('bk_tbl');
  if(tbl){
    const headers=[...tbl.tHead.rows[0].cells].map(th=>th.textContent);
    let maxRPM=0, z5Agg=0, recAgg=0, totalRows=0;
    [...tbl.tBodies[0].rows].forEach(r=>{
      totalRows++;
      headers.forEach((h,idx)=>{
        if(idx===0) return;
        const val=r.cells[idx].querySelector('input')?.value?.trim();
        if(/RPM/i.test(h)){ const rpm=parseFloat(val); if(isFinite(rpm)) maxRPM=Math.max(maxRPM,rpm||0); }
        if(/Zone 5/i.test(h)){ const sec=parseFloat(val); if(isFinite(sec)) z5Agg+=sec; }
        if(/Recovery/i.test(h)){ const sec=parseFloat(val); if(isFinite(sec)) recAgg+=sec; }
      });
    });
    if(maxRPM>=110) cns+=6;
    if(proto==='c_peak_then_z5' && totalRows>0){
      const avgZ5=z5Agg/totalRows; if(avgZ5<=30) cns+=8; else if(avgZ5<=45) cns+=5; else cns+=2;
    }
    if(proto==='c_max_rpm' && maxRPM>0){ tss += Math.round(maxRPM/10); }
  }

  document.getElementById('bk_tss').textContent=tss;
  document.getElementById('bk_cns').textContent=Math.max(0,Math.min(100,Math.round(cns)));
  document.getElementById('bk_next').textContent=nextBikeSuggestion(proto,tss,cns);
}
function nextBikeSuggestion(proto,tss,cns){
  const last = JSON.parse(localStorage.getItem('ets_last_bike')||'null');
  if(!last) return "Log 1‚Äì2 sessions to unlock progression.";
  const delta=tss-last.tss;
  if(proto==='pi_gasTank'){
    if(delta>20) return "Hold duration; add cadence drills.";
    if(delta<-15) return "Add +5 min next Z2 ride.";
    return "Maintain; check HR drift.";
  }
  if(proto==='c_max_rpm'){
    const mx = Math.max(last.sessionMaxRPM||0, 0);
    return mx? `Target ‚â• ${Math.round(mx*1.02)} RPM peak next time.`:"Establish a true peak today.";
  }
  return delta>0? "Micro-deload next session.":"Progress +1 rep.";
}

/* =================== SAVE DAY (uses previous logic + bike override) =================== */
let hrData={};
async function saveDay(dateStr){
  const data={modalities:{}, totalCNS:0, totalVolume:0, tss:0, qualities:{} };
  const types=['chest','back','legs','track','bike','bjj','walking'];
  for(const t of types){
    const cb=document.getElementById('check-'+t);
    if(cb && cb.checked){
      const m=await collectModalityData(t);
      if(m){ data.modalities[t]=m; data.modalities[t].completed=true; }
    }
  }
  if(Object.keys(data.modalities).length===0){ alert('Select at least one modality.'); return; }
  Object.keys(data.modalities).forEach(t=>{ const mod=data.modalities[t]; data.totalCNS+=mod.cnsScore||0; data.totalVolume+=mod.volume||0; data.tss+=mod.tss||0; });
  data.qualities = analyzeQualities(data.modalities);
  data.interference = detectInterference(data.modalities, data.qualities);
  trainingData[dateStr]=data; historicalTSS.push({date:dateStr,tss:data.tss}); if(historicalTSS.length>28) historicalTSS.shift();
  saveData(); displayDayAnalysis(dateStr,data);
}

async function collectModalityData(type){
  const data={type};
  if(type==='bike'){
    // upgraded
    const proto=(document.getElementById('bk_proto')||{}).value||'pi_gasTank';
    const rounds=parseInt((document.getElementById('bk_rounds')||{}).value)||0;
    const feel=(document.getElementById('bk_feel')||{}).value||'';
    const sleep=parseFloat((document.getElementById('bk_sleep')||{}).value)||0;
    const hr=hrStore['bike']||null;
    const tbl=document.getElementById('bk_tbl');
    let tableData=[]; let sessionMaxRPM=0;
    if(tbl){
      const headers=[...tbl.tHead.rows[0].cells].map(th=>th.textContent.trim());
      tableData=[...tbl.tBodies[0].rows].map(r=>{
        const row={}; [...r.cells].forEach((c,i)=>{
          row[headers[i]] = i===0? c.textContent.trim() : c.querySelector('input')?.value?.trim();
          if(/RPM/i.test(headers[i])){ const v=parseFloat(row[headers[i]]); if(isFinite(v)) sessionMaxRPM=Math.max(sessionMaxRPM,v); }
        }); return row;
      });
    }
    // compute via the same function for consistency
    computeBikeMetricsUpgraded();
    const tss=parseInt(document.getElementById('bk_tss').textContent)||0;
    const cns=parseInt(document.getElementById('bk_cns').textContent)||0;
    return { protocol:proto, rounds, feel, sleep, hrAnalysis:hr, cnsScore:cns, tss, volume:0, tableData, sessionMaxRPM };
  }
  // fallback simple for others (retain existing scoring heuristics)
  if(type==='track'){
    data.contacts=parseInt(document.getElementById('track-contacts')?.value)||0;
    data.maxJumps=parseInt(document.getElementById('track-max-jumps')?.value)||0;
    data.sprints=parseInt(document.getElementById('track-sprints')?.value)||0;
    data.ground=document.getElementById('track-ground')?.value||'';
    data.energy=document.getElementById('track-energy')?.value||'';
    data.achilles=document.getElementById('track-achilles')?.value||'';
    data.sleep=parseFloat(document.getElementById('track-sleep')?.value)||0;
    // quick metrics
    let cns=35; if(data.ground==='heavy') cns+=25; if(data.energy==='low') cns+=18; if(data.achilles==='sore') cns+=25;
    if(data.contacts>350) cns+=15; if(data.maxJumps>10) cns+=data.maxJumps*2; if(data.sleep<7) cns+=12;
    const tss=60 + (data.contacts*0.15) + (data.maxJumps*2);
    return { ...data, cnsScore:Math.min(100,cns), tss:Math.round(tss), volume:0 };
  }
  if(type==='bjj'){
    data.time=parseInt(document.getElementById('bjj-time')?.value)||0;
    data.intensity=document.getElementById('bjj-intensity')?.value||'';
    data.weightBefore=parseFloat(document.getElementById('bjj-weight-before')?.value)||0;
    data.weightAfter=parseFloat(document.getElementById('bjj-weight-after')?.value)||0;
    data.weightLoss=(data.weightBefore-data.weightAfter).toFixed(1);
    data.feeling=document.getElementById('bjj-feeling')?.value||'';
    data.sleep=parseFloat(document.getElementById('bjj-sleep')?.value)||0;
    let cns=40; const sweat=parseFloat(data.weightLoss)||0; if(sweat>=4) cns+=20; else if(sweat>=3) cns+=10;
    if(data.intensity==='high') cns+=15; if(data.feeling==='beat') cns+=20; if(data.feeling==='tired') cns+=12; if(data.sleep<7) cns+=10;
    const tss=data.time*1.5 + (data.intensity==='high'?30:0);
    return { ...data, cnsScore:Math.min(100,cns), tss:Math.round(tss), volume:0 };
  }
  if(type==='walking'){
    data.duration=parseInt(document.getElementById('walking-duration')?.value)||0;
    data.distance=parseFloat(document.getElementById('walking-distance')?.value)||0;
    data.pace=parseFloat(document.getElementById('walking-pace')?.value)||0;
    data.terrain=document.getElementById('walking-terrain')?.value||'';
    data.purpose=document.getElementById('walking-purpose')?.value||'';
    let cns=10; if(data.terrain==='steep') cns+=15; else if(data.terrain==='hills') cns+=8;
    const tss=data.duration*0.5;
    return { ...data, cnsScore:Math.min(100,cns), tss:Math.round(tss), volume:0 };
  }
  if(type==='chest'||type==='back'||type==='legs'){
    const tbl=document.getElementById(type+'-tbl'); let totalVol=0, rpeSum=0, rpeCnt=0;
    [...tbl.tBodies[0].rows].forEach(r=>{
      const w=parseFloat(r.cells[1].querySelector('input').value)||0;
      const reps=parseInt(r.cells[2].querySelector('input').value)||0;
      const p=parseFloat(r.cells[3].querySelector('input').value)||0;
      totalVol += w*reps; if(p){ rpeSum+=p; rpeCnt++; }
    });
    const avgRPE = rpeCnt? rpeSum/rpeCnt : 0;
    let cns=40; if(avgRPE>=9) cns+=15; else if(avgRPE>=8.5) cns+=10; else if(avgRPE<=7) cns-=8;
    const feel=document.getElementById(type+'-feeling')?.value||''; const sleep=parseFloat(document.getElementById(type+'-sleep')?.value)||0;
    if(feel==='beat') cns+=20; else if(feel==='tired') cns+=12; else if(feel==='great') cns-=8;
    if(sleep<6.5) cns+=15; else if(sleep>=8) cns-=8;
    const tss = Math.round(60 * (avgRPE/10) * 100 / 100); // simple
    return { exercises:[], feeling:feel, sleep, avgRPE:avgRPE.toFixed(1), cnsScore:Math.min(100,cns), tss, volume:totalVol };
  }
  return null;
}

/* =================== QUALITIES & INTERFERENCE (unchanged) =================== */
function analyzeQualities(modalities){
  const q={strength:0,hypertrophy:0,power:0,speed:0,endurance:0};
  Object.keys(modalities).forEach(type=>{
    const mod=modalities[type];
    if(type==='chest'||type==='back'||type==='legs'){
      if(mod.avgRPE){ const r=Number(mod.avgRPE); if(r>=8) q.hypertrophy+=40; if(r<=6) q.strength+=30; }
      q.strength += (mod.volume||0)*0.001;
      q.hypertrophy += (mod.volume||0)*0.001;
    } else if(type==='track'){ q.power += (mod.maxJumps||0)*20; q.speed += (mod.sprints||0)*25; }
    else if(type==='bike'){ q.endurance += 60; if((mod.protocol||'').includes('vo2')||mod.protocol==='pi_mixed') q.power+=30; }
    else if(type==='bjj'){ q.endurance+=50; if(mod.intensity==='high'){ q.power+=30; q.strength+=20; } }
    else if(type==='walking'){ q.endurance+=25; }
  });
  const total=Object.values(q).reduce((a,b)=>a+b,0);
  if(total>0) Object.keys(q).forEach(k=> q[k]=Math.round(q[k]/total*100));
  return q;
}
function detectInterference(modalities,qualities){
  const issues=[]; const types=Object.keys(modalities);
  if(types.includes('legs') && types.includes('track')) issues.push({severity:'critical',message:'Legs + Track same day = Type II fiber overload',impact:'Power compromised 15‚Äì20%',fix:'Separate by ‚â•48h'});
  if(types.includes('bjj') && types.includes('back')) issues.push({severity:'moderate',message:'BJJ + Back = Grip fatigue compounding',impact:'Pulling strength reduced 10‚Äì15%',fix:'Use straps or separate days'});
  if(types.length>=4) issues.push({severity:'high',message:`${types.length} modalities in one day = extreme volume`,impact:'CNS overload',fix:'Split across 2 days'});
  return issues;
}

/* =================== DAY ANALYSIS DISPLAY (unchanged) =================== */
function displayDayAnalysis(dateStr,data){
  renderCalendar();
  const modalityList=Object.keys(data.modalities).map(t=>t.toUpperCase()).join(', ');
  let html=`
    <div class="modal"><div class="modal-content">
      <div class="modal-header"><div class="modal-title">‚úì Training Saved</div><button class="close-btn" onclick="closeAnyModal()">Close</button></div>
      <div class="ok"><b>${dateStr}</b> ‚Ä¢ Modalities: ${modalityList}</div>
      <div class="metrics-grid">
        <div class="metric-card"><div class="metric-value">${data.totalCNS}</div><div>Total CNS Load</div></div>
        <div class="metric-card"><div class="metric-value">${(data.totalVolume||0).toLocaleString()}</div><div>Volume (lb)</div></div>
        <div class="metric-card"><div class="metric-value">${data.tss}</div><div>Training Stress Score</div></div>
      </div>
      <div class="modality-section"><h2>Training Qualities</h2>
        ${Object.keys(data.qualities).map(k=>`<div>${k[0].toUpperCase()+k.slice(1)}: <b>${data.qualities[k]}%</b></div>`).join('')}
      </div>`;
  if(data.interference && data.interference.length){
    html+=`<div class="warn"><h3>‚ö†Ô∏è Interference</h3>`+data.interference.map(i=>`<div style="margin:6px 0"><b>${i.message}</b><div style="color:#ff9999">Impact: ${i.impact}</div><div style="color:#00ff88">Fix: ${i.fix}</div></div>`).join('')+`</div>`;
  }
  html+=`</div></div>`;
  const node=document.getElementById('day-modal'); node.innerHTML=html; node.classList.remove('hidden');
}

/* =================== WEEKLY ANALYSIS (unchanged minimal) =================== */
function showWeeklyAnalysis(){
  const end=new Date(); const start=new Date(); start.setDate(start.getDate()-6);
  let totalCNS=0,totalVol=0,totalTSS=0,days=0,dailyCNS=[],dailyTSS=[];
  for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
    const ds=formatDate(d), day=trainingData[ds];
    if(day && day.modalities && Object.keys(day.modalities).length){
      days++; totalCNS+=day.totalCNS||0; totalVol+=day.totalVolume||0; totalTSS+=day.tss||0; dailyCNS.push(day.totalCNS||0); dailyTSS.push(day.tss||0);
    }
  }
  const avgCNS=days?Math.round(totalCNS/days):0; const avgTSS=days?Math.round(totalTSS/days):0;
  const mean=avgCNS, variance=dailyCNS.reduce((s,v)=>s+Math.pow(v-mean,2),0)/(dailyCNS.length||1), std=Math.sqrt(variance), monotony = std>0 ? (mean/std).toFixed(2) : 0;
  const strain=Math.round(totalCNS*parseFloat(monotony||0));
  const last28=historicalTSS.slice(-28); let ac='‚Äî', warn=false;
  if(last28.length>=14){ const chronic=last28.reduce((a,b)=>a+b.tss,0)/last28.length; if(chronic>0){ ac=(avgTSS*7/chronic).toFixed(2); if(parseFloat(ac)>1.3) warn=true; } }
  const html=`
    <div class="modal"><div class="modal-content">
      <div class="modal-header"><div class="modal-title">üìä Weekly Analysis</div><button class="close-btn" onclick="closeAnyModal()">Close</button></div>
      <div class="metrics-grid">
        <div class="metric-card"><div class="metric-value">${totalVol.toLocaleString()}</div><div>Total Volume (lb)</div></div>
        <div class="metric-card"><div class="metric-value">${avgCNS}</div><div>Avg Daily CNS</div></div>
        <div class="metric-card"><div class="metric-value">${totalTSS}</div><div>Weekly TSS</div></div>
        <div class="metric-card"><div class="metric-value" style="color:${warn?'#ff4444':'#00ff88'}">${ac}</div><div>Acute:Chronic</div></div>
        <div class="metric-card"><div class="metric-value">${monotony}</div><div>Monotony</div></div>
        <div class="metric-card"><div class="metric-value">${strain}</div><div>Strain</div></div>
      </div>
      ${warn?`<div class="warn"><b>Injury risk elevated</b> ‚Äî reduce volume 15‚Äì20% next week; add rest; prioritize sleep.</div>`:`<div class="ok">Load within safe range. Maintain progression.</div>`}
    </div></div>`;
  const node=document.getElementById('weekly-modal'); node.innerHTML=html; node.classList.remove('hidden');
}

/* =================== INIT =================== */
window.onload=function(){ loadData(); renderCalendar(); };
</script>
</body>
</html>
